<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-164971995-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-164971995-1');
    </script>

    <title>Formulae Auto-Derivation for Nested Logit Models - Jianghao's blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="/formulae-auto-derivation-for-nested-logit-models.html">

        <meta name="author" content="Jianghao" />
        <meta name="keywords" content="SymPy,Nested Logit" />
        <meta name="description" content="This file uses the Symbolic Python (SymPy) package to derive the elasticity formulae for Nested Logit Models. SymPy is a Python library for symbolic mathematics. It aims to become a full-featured computer algebra system (CAS) while keeping the code as simple as possible in order to be comprehensible and easily …" />

        <meta property="og:site_name" content="Jianghao's blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Formulae Auto-Derivation for Nested Logit Models"/>
        <meta property="og:url" content="/formulae-auto-derivation-for-nested-logit-models.html"/>
        <meta property="og:description" content="This file uses the Symbolic Python (SymPy) package to derive the elasticity formulae for Nested Logit Models. SymPy is a Python library for symbolic mathematics. It aims to become a full-featured computer algebra system (CAS) while keeping the code as simple as possible in order to be comprehensible and easily …"/>
        <meta property="article:published_time" content="2020-11-29" />
            <meta property="article:section" content="Python" />
            <meta property="article:tag" content="SymPy" />
            <meta property="article:tag" content="Nested Logit" />
            <meta property="article:author" content="Jianghao" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/solarizedlight.css" rel="stylesheet">
    <link href="/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>



</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
Jianghao's blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="/pages/about-me.html">
                             About Me
                          </a></li>
                        <li >
                            <a href="/category/bash.html">Bash</a>
                        </li>
                        <li >
                            <a href="/category/econometrics.html">Econometrics</a>
                        </li>
                        <li >
                            <a href="/category/git.html">Git</a>
                        </li>
                        <li >
                            <a href="/category/other.html">Other</a>
                        </li>
                        <li class="active">
                            <a href="/category/python.html">Python</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/formulae-auto-derivation-for-nested-logit-models.html"
                       rel="bookmark"
                       title="Permalink to Formulae Auto-Derivation for Nested Logit Models">
                        Formulae Auto-Derivation for Nested Logit Models
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2020-11-29T00:00:00+01:00"> Sun 29 November 2020</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="/tag/sympy.html">SymPy</a>
        /
	<a href="/tag/nested-logit.html">Nested Logit</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>This file uses the Symbolic Python (SymPy) package to derive the elasticity formulae for Nested Logit Models. SymPy is a Python library for symbolic mathematics. It aims to become a full-featured computer algebra system (CAS) while keeping the code as simple as possible in order to be comprehensible and easily extensible. More details about SymPy can be found on the SymPy package main page: <a href="https://www.sympy.org/en/index.html">SymPy</a>.</p>
<p>To use the SymPy package, we first have to import the SymPy package as follows. Note that we also include the <code>init_printing()</code> function to enable the pretty print which is particularly useful when we are printing a large amount of mathematical formulae.</p>
<div class="highlight"><pre><span></span><span class="c1">#### Import libraries</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">init_printing</span><span class="p">()</span>
</pre></div>


<p>Before doing the real math, first let us familiarize ourselves with the basic functions in SymPy that we are going to use. Before using a symbolic mathematical variable, we have to define the variable using <code>Symbol()</code>. Then we can go on and doing simple mathematics just like how we will do them in Python.</p>
<div class="highlight"><pre><span></span><span class="c1"># Define new symbolic mathematical variables and add them up</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>


<p><img src="https://render.githubusercontent.com/render/math?math=a %2B b"></p>
<p>Another helpful function in SymPy that we are going to use a lot is taking the derivative, <code>diff()</code>.</p>
<div class="highlight"><pre><span></span><span class="c1"># Taking the derivative of a mathematical expression with respect to the varaible a</span>
<span class="n">diff</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span>
</pre></div>


<p><img src="https://render.githubusercontent.com/render/math?math=- \left(a %2B b\right)^{a %2B b} \left(\log{\left (a %2B b \right )} %2B 1\right) %2B \cos{\left (a %2B b \right )}"></p>
<p>The last function that we are going to use heavily later is the subs() method of a SymPy expression. We will use this function to substitute certain part of the express with something that is more readable and understandable to human eyes.</p>
<div class="highlight"><pre><span></span><span class="c1"># Subtitute (a + b) with t to simplify the expression</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">diff</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</pre></div>


<p><img src="https://render.githubusercontent.com/render/math?math=- t^{t} \left(\log{\left (t \right )} %2B 1\right) %2B \cos{\left (t \right )}"></p>
<p>Next, let's set up our model by specifying a few basic parameters in the model.</p>
<div class="highlight"><pre><span></span><span class="c1">#### Settings</span>
<span class="n">number_end_group</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># This is the number of vehicles in each end group of our tree</span>
<span class="n">number_splits_non_end_node</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># This is the number of splits for each node if the node is not on the last two levels</span>
<span class="n">depth_of_tree</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># This is the depth of our tree</span>
</pre></div>


<p>From the above settings, we build up a tree with the following structre.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="n">decision_node</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;sawtooth&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;0.8&quot;</span><span class="p">)</span>
<span class="n">leaf_node</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round4&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;0.8&quot;</span><span class="p">)</span>
<span class="n">arrow_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;&lt;-&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_leaf_num</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
    <span class="n">leaf_num</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;dict&quot;</span><span class="p">:</span>
            <span class="n">leaf_num</span> <span class="o">+=</span><span class="n">get_leaf_num</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">leaf_num</span> <span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">leaf_num</span>


<span class="k">def</span> <span class="nf">get_tree_depth</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;dict&quot;</span><span class="p">:</span>
            <span class="n">thisdepth</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span> <span class="n">get_tree_depth</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thisdepth</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">thisdepth</span><span class="o">&gt;</span><span class="n">depth</span><span class="p">:</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">thisdepth</span>
    <span class="k">return</span> <span class="n">depth</span>


<span class="k">def</span> <span class="nf">plotNode</span><span class="p">(</span><span class="n">nodeTxt</span><span class="p">,</span> <span class="n">centerPt</span><span class="p">,</span> <span class="n">parentPt</span><span class="p">,</span> <span class="n">nodeType</span><span class="p">):</span>
    <span class="n">createPlot</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">nodeTxt</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="n">parentPt</span><span class="p">,</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
                            <span class="n">xytext</span><span class="o">=</span><span class="n">centerPt</span><span class="p">,</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
                            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">nodeType</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="n">arrow_args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plotTree</span><span class="p">(</span><span class="n">myTree</span><span class="p">,</span> <span class="n">parentPt</span><span class="p">,</span> <span class="n">nodeTxt</span><span class="p">):</span>
    <span class="n">numLeafs</span> <span class="o">=</span> <span class="n">get_leaf_num</span><span class="p">(</span><span class="n">myTree</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">get_tree_depth</span><span class="p">(</span><span class="n">myTree</span><span class="p">)</span>
    <span class="n">firstStr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">myTree</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cntrPt</span> <span class="o">=</span> <span class="p">(</span><span class="n">plotTree</span><span class="o">.</span><span class="n">xOff</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">numLeafs</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">plotTree</span><span class="o">.</span><span class="n">totalW</span><span class="p">,</span> <span class="n">plotTree</span><span class="o">.</span><span class="n">yOff</span><span class="p">)</span>
    <span class="n">plotNode</span><span class="p">(</span><span class="n">firstStr</span><span class="p">,</span> <span class="n">cntrPt</span><span class="p">,</span> <span class="n">parentPt</span><span class="p">,</span> <span class="n">decision_node</span><span class="p">)</span>
    <span class="n">secondDict</span> <span class="o">=</span> <span class="n">myTree</span><span class="p">[</span><span class="n">firstStr</span><span class="p">]</span>
    <span class="n">plotTree</span><span class="o">.</span><span class="n">yOff</span> <span class="o">=</span> <span class="n">plotTree</span><span class="o">.</span><span class="n">yOff</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">plotTree</span><span class="o">.</span><span class="n">totalD</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">myTree</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">myTree</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;dict&#39;</span><span class="p">:</span>
            <span class="n">plotTree</span><span class="p">(</span><span class="n">myTree</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">cntrPt</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plotTree</span><span class="o">.</span><span class="n">xOff</span> <span class="o">=</span> <span class="n">plotTree</span><span class="o">.</span><span class="n">xOff</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">plotTree</span><span class="o">.</span><span class="n">totalW</span>
            <span class="n">plotNode</span><span class="p">(</span><span class="n">myTree</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">(</span><span class="n">plotTree</span><span class="o">.</span><span class="n">xOff</span><span class="p">,</span> <span class="n">plotTree</span><span class="o">.</span><span class="n">yOff</span><span class="p">),</span> <span class="n">cntrPt</span><span class="p">,</span> <span class="n">leaf_node</span><span class="p">)</span>
    <span class="n">plotTree</span><span class="o">.</span><span class="n">yOff</span> <span class="o">=</span> <span class="n">plotTree</span><span class="o">.</span><span class="n">yOff</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">plotTree</span><span class="o">.</span><span class="n">totalD</span>


<span class="k">def</span> <span class="nf">createPlot</span><span class="p">(</span><span class="n">inTree</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">axprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">createPlot</span><span class="o">.</span><span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">axprops</span><span class="p">)</span>
    <span class="n">plotTree</span><span class="o">.</span><span class="n">totalW</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_leaf_num</span><span class="p">(</span><span class="n">inTree</span><span class="p">))</span>
    <span class="n">plotTree</span><span class="o">.</span><span class="n">totalD</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_tree_depth</span><span class="p">(</span><span class="n">inTree</span><span class="p">))</span>
    <span class="n">plotTree</span><span class="o">.</span><span class="n">xOff</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">plotTree</span><span class="o">.</span><span class="n">totalW</span>
    <span class="n">plotTree</span><span class="o">.</span><span class="n">yOff</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">plotTree</span><span class="p">(</span><span class="n">inTree</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">create_dict</span><span class="p">(</span><span class="n">level</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">count</span><span class="p">,</span> <span class="n">number_end_group</span><span class="p">,</span> <span class="n">number_splits_non_end_node</span><span class="p">,</span> <span class="n">depth_of_tree</span>
    <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">depth_of_tree</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_end_group</span><span class="p">):</span>
            <span class="n">dic</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">count</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">dic</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_splits_non_end_node</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">dic</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">create_dict</span><span class="p">(</span><span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dic</span>


<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">createPlot</span><span class="p">(</span><span class="n">create_dict</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</pre></div>


<p><img alt="png" src="images/output_5_0.png"></p>
<p>Now that we finished setting up our model we can start calculating the formulae of interest. Let's first review the formulae for the share and elasticities in the Nested Logit Model. The share of one end node in the Nested Logit Model is</p>
<p><img src="https://render.githubusercontent.com/render/math?math=s_j = \frac{\left(\left(\left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)^{\frac{\theta_{2 0}}{\theta_{1 0}}} %2B \left(e^{\frac{v_{3}}{\theta_{2 1}}} %2B e^{\frac{v_{4}}{\theta_{2 1}}} %2B e^{\frac{v_{5}}{\theta_{2 1}}}\right)^{\frac{\theta_{2 1}}{\theta_{1 0}}}\right)^{\frac{\theta_{1 0}}{\theta_{0 0}}} %2B \left(\left(e^{\frac{v_{6}}{\theta_{2 2}}} %2B e^{\frac{v_{7}}{\theta_{2 2}}} %2B e^{\frac{v_{8}}{\theta_{2 2}}}\right)^{\frac{\theta_{2 2}}{\theta_{1 1}}} %2B \left(e^{\frac{v_{10}}{\theta_{2 3}}} %2B e^{\frac{v_{11}}{\theta_{2 3}}} %2B e^{\frac{v_{9}}{\theta_{2 3}}}\right)^{\frac{\theta_{2 3}}{\theta_{1 1}}}\right)^{\frac{\theta_{1 1}}{\theta_{0 0}}}\right)^{\theta_{0 0}} \left(\left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)^{\frac{\theta_{2 0}}{\theta_{1 0}}} %2B \left(e^{\frac{v_{3}}{\theta_{2 1}}} %2B e^{\frac{v_{4}}{\theta_{2 1}}} %2B e^{\frac{v_{5}}{\theta_{2 1}}}\right)^{\frac{\theta_{2 1}}{\theta_{1 0}}}\right)^{\frac{\theta_{1 0}}{\theta_{0 0}}} \left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)^{\frac{\theta_{2 0}}{\theta_{1 0}}} e^{\frac{v_{0}}{\theta_{2 0}}}}{\left(\left(\left(\left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)^{\frac{\theta_{2 0}}{\theta_{1 0}}} %2B \left(e^{\frac{v_{3}}{\theta_{2 1}}} %2B e^{\frac{v_{4}}{\theta_{2 1}}} %2B e^{\frac{v_{5}}{\theta_{2 1}}}\right)^{\frac{\theta_{2 1}}{\theta_{1 0}}}\right)^{\frac{\theta_{1 0}}{\theta_{0 0}}} %2B \left(\left(e^{\frac{v_{6}}{\theta_{2 2}}} %2B e^{\frac{v_{7}}{\theta_{2 2}}} %2B e^{\frac{v_{8}}{\theta_{2 2}}}\right)^{\frac{\theta_{2 2}}{\theta_{1 1}}} %2B \left(e^{\frac{v_{10}}{\theta_{2 3}}} %2B e^{\frac{v_{11}}{\theta_{2 3}}} %2B e^{\frac{v_{9}}{\theta_{2 3}}}\right)^{\frac{\theta_{2 3}}{\theta_{1 1}}}\right)^{\frac{\theta_{1 1}}{\theta_{0 0}}}\right)^{\theta_{0 0}} %2B 1\right) \left(\left(\left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)^{\frac{\theta_{2 0}}{\theta_{1 0}}} %2B \left(e^{\frac{v_{3}}{\theta_{2 1}}} %2B e^{\frac{v_{4}}{\theta_{2 1}}} %2B e^{\frac{v_{5}}{\theta_{2 1}}}\right)^{\frac{\theta_{2 1}}{\theta_{1 0}}}\right)^{\frac{\theta_{1 0}}{\theta_{0 0}}} %2B \left(\left(e^{\frac{v_{6}}{\theta_{2 2}}} %2B e^{\frac{v_{7}}{\theta_{2 2}}} %2B e^{\frac{v_{8}}{\theta_{2 2}}}\right)^{\frac{\theta_{2 2}}{\theta_{1 1}}} %2B \left(e^{\frac{v_{10}}{\theta_{2 3}}} %2B e^{\frac{v_{11}}{\theta_{2 3}}} %2B e^{\frac{v_{9}}{\theta_{2 3}}}\right)^{\frac{\theta_{2 3}}{\theta_{1 1}}}\right)^{\frac{\theta_{1 1}}{\theta_{0 0}}}\right) \left(\left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)^{\frac{\theta_{2 0}}{\theta_{1 0}}} %2B \left(e^{\frac{v_{3}}{\theta_{2 1}}} %2B e^{\frac{v_{4}}{\theta_{2 1}}} %2B e^{\frac{v_{5}}{\theta_{2 1}}}\right)^{\frac{\theta_{2 1}}{\theta_{1 0}}}\right) \left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)}."></p>
<h3>Self-elasticity</h3>
<p>The self-elasticity of the node is</p>
<p><img src="https://render.githubusercontent.com/render/math?math=self\_elas = \beta p_{0} \left(- s_{3} %2B \frac{1}{\theta_{2 0}} - \frac{s_{3}}{s_{2} \theta_{2 0}} %2B \frac{s_{3}}{s_{2} \theta_{1 0}} - \frac{s_{3}}{s_{1} \theta_{1 0}} %2B \frac{s_{3}}{s_{1} \theta_{0 0}} %2B \frac{s_{3}}{s_{0}} - \frac{s_{3}}{s_{0} \theta_{0 0}}\right),"></p>
<p>and the cross-elasticity of the node with another node within the same group in the second to last layer is</p>
<p><img src="https://render.githubusercontent.com/render/math?math=cross\_elas = \beta p_{1} \left(- s_{3} - \frac{s_{3}}{s_{2} \theta_{2 0}} %2B \frac{s_{3}}{s_{2} \theta_{1 0}} - \frac{s_{3}}{s_{1} \theta_{1 0}} %2B \frac{s_{3}}{s_{1} \theta_{0 0}} %2B \frac{s_{3}}{s_{0}} - \frac{s_{3}}{s_{0} \theta_{0 0}}\right)."></p>
<div class="highlight"><pre><span></span><span class="c1"># Basic elements for calculation</span>
<span class="n">total_end_nodes</span> <span class="o">=</span> <span class="n">number_splits_non_end_node</span> <span class="o">**</span> <span class="p">(</span><span class="n">depth_of_tree</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">number_end_group</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_end_nodes</span><span class="p">):</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;p_</span><span class="si">%d</span><span class="s1"> = symbols(&quot;p_</span><span class="si">%d</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
<span class="n">total_theta</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth_of_tree</span><span class="p">):</span>
    <span class="n">total_theta</span> <span class="o">+=</span> <span class="n">number_splits_non_end_node</span> <span class="o">**</span> <span class="n">i</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_end_nodes</span><span class="p">):</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;v_</span><span class="si">%d</span><span class="s1"> = symbols(&quot;v_</span><span class="si">%d</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth_of_tree</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_splits_non_end_node</span> <span class="o">**</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;theta_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> = symbols(&quot;theta_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth_of_tree</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;s_</span><span class="si">%d</span><span class="s1"> = symbols(&quot;s_</span><span class="si">%d</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Intermediate sums in s</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_end_nodes</span><span class="p">):</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;sum_exp_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> = exp(v_</span><span class="si">%d</span><span class="s1"> / theta_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">depth_of_tree</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">//</span> <span class="n">number_end_group</span><span class="p">))</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_end_nodes</span> <span class="o">//</span> <span class="n">number_end_group</span><span class="p">):</span>
    <span class="n">st</span> <span class="o">=</span> <span class="s1">&#39;sum_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> =&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">number_end_group</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">number_end_group</span> <span class="o">+</span> <span class="n">number_end_group</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="s1">&#39; exp(v_</span><span class="si">%d</span><span class="s1"> / theta_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">) +&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">st</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;sum_exp_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> = sum_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> ** (theta_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> / theta_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
                                                                       <span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">//</span><span class="n">number_splits_non_end_node</span><span class="p">))</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_splits_non_end_node</span> <span class="o">**</span> <span class="n">k</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="s1">&#39;sum_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> =&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">number_splits_non_end_node</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">number_splits_non_end_node</span><span class="p">):</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="s1">&#39; sum_exp_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> +&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">st</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;sum_exp_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> = sum_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> ** (theta_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> / theta_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
                                                                       <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">//</span><span class="n">number_splits_non_end_node</span><span class="p">))</span>

<span class="n">st</span> <span class="o">=</span> <span class="s1">&#39;sum_0_0 =&#39;</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_splits_non_end_node</span><span class="p">):</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="s1">&#39; sum_exp_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> +&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
<span class="n">exec</span><span class="p">(</span><span class="n">st</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">exec</span><span class="p">(</span><span class="s1">&#39;sum_exp_0_0 = sum_0_0 ** (theta_0_0)&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Calculate final expression for s</span>
<span class="n">exec</span><span class="p">(</span><span class="s1">&#39;s = sum_exp_</span><span class="si">%d</span><span class="s1">_0 / (1 + sum_0_0 ** theta_0_0)&#39;</span> <span class="o">%</span> <span class="n">depth_of_tree</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth_of_tree</span><span class="p">):</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;s = s / sum_</span><span class="si">%d</span><span class="s1">_0 * sum_exp_</span><span class="si">%d</span><span class="s1">_0&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">s</span>
</pre></div>


<p><img src="https://render.githubusercontent.com/render/math?math=\frac{\left(\left(\left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)^{\frac{\theta_{2 0}}{\theta_{1 0}}} %2B \left(e^{\frac{v_{3}}{\theta_{2 1}}} %2B e^{\frac{v_{4}}{\theta_{2 1}}} %2B e^{\frac{v_{5}}{\theta_{2 1}}}\right)^{\frac{\theta_{2 1}}{\theta_{1 0}}}\right)^{\frac{\theta_{1 0}}{\theta_{0 0}}} %2B \left(\left(e^{\frac{v_{6}}{\theta_{2 2}}} %2B e^{\frac{v_{7}}{\theta_{2 2}}} %2B e^{\frac{v_{8}}{\theta_{2 2}}}\right)^{\frac{\theta_{2 2}}{\theta_{1 1}}} %2B \left(e^{\frac{v_{10}}{\theta_{2 3}}} %2B e^{\frac{v_{11}}{\theta_{2 3}}} %2B e^{\frac{v_{9}}{\theta_{2 3}}}\right)^{\frac{\theta_{2 3}}{\theta_{1 1}}}\right)^{\frac{\theta_{1 1}}{\theta_{0 0}}}\right)^{\theta_{0 0}} \left(\left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)^{\frac{\theta_{2 0}}{\theta_{1 0}}} %2B \left(e^{\frac{v_{3}}{\theta_{2 1}}} %2B e^{\frac{v_{4}}{\theta_{2 1}}} %2B e^{\frac{v_{5}}{\theta_{2 1}}}\right)^{\frac{\theta_{2 1}}{\theta_{1 0}}}\right)^{\frac{\theta_{1 0}}{\theta_{0 0}}} \left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)^{\frac{\theta_{2 0}}{\theta_{1 0}}} e^{\frac{v_{0}}{\theta_{2 0}}}}{\left(\left(\left(\left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)^{\frac{\theta_{2 0}}{\theta_{1 0}}} %2B \left(e^{\frac{v_{3}}{\theta_{2 1}}} %2B e^{\frac{v_{4}}{\theta_{2 1}}} %2B e^{\frac{v_{5}}{\theta_{2 1}}}\right)^{\frac{\theta_{2 1}}{\theta_{1 0}}}\right)^{\frac{\theta_{1 0}}{\theta_{0 0}}} %2B \left(\left(e^{\frac{v_{6}}{\theta_{2 2}}} %2B e^{\frac{v_{7}}{\theta_{2 2}}} %2B e^{\frac{v_{8}}{\theta_{2 2}}}\right)^{\frac{\theta_{2 2}}{\theta_{1 1}}} %2B \left(e^{\frac{v_{10}}{\theta_{2 3}}} %2B e^{\frac{v_{11}}{\theta_{2 3}}} %2B e^{\frac{v_{9}}{\theta_{2 3}}}\right)^{\frac{\theta_{2 3}}{\theta_{1 1}}}\right)^{\frac{\theta_{1 1}}{\theta_{0 0}}}\right)^{\theta_{0 0}} %2B 1\right) \left(\left(\left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)^{\frac{\theta_{2 0}}{\theta_{1 0}}} %2B \left(e^{\frac{v_{3}}{\theta_{2 1}}} %2B e^{\frac{v_{4}}{\theta_{2 1}}} %2B e^{\frac{v_{5}}{\theta_{2 1}}}\right)^{\frac{\theta_{2 1}}{\theta_{1 0}}}\right)^{\frac{\theta_{1 0}}{\theta_{0 0}}} %2B \left(\left(e^{\frac{v_{6}}{\theta_{2 2}}} %2B e^{\frac{v_{7}}{\theta_{2 2}}} %2B e^{\frac{v_{8}}{\theta_{2 2}}}\right)^{\frac{\theta_{2 2}}{\theta_{1 1}}} %2B \left(e^{\frac{v_{10}}{\theta_{2 3}}} %2B e^{\frac{v_{11}}{\theta_{2 3}}} %2B e^{\frac{v_{9}}{\theta_{2 3}}}\right)^{\frac{\theta_{2 3}}{\theta_{1 1}}}\right)^{\frac{\theta_{1 1}}{\theta_{0 0}}}\right) \left(\left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)^{\frac{\theta_{2 0}}{\theta_{1 0}}} %2B \left(e^{\frac{v_{3}}{\theta_{2 1}}} %2B e^{\frac{v_{4}}{\theta_{2 1}}} %2B e^{\frac{v_{5}}{\theta_{2 1}}}\right)^{\frac{\theta_{2 1}}{\theta_{1 0}}}\right) \left(e^{\frac{v_{0}}{\theta_{2 0}}} %2B e^{\frac{v_{1}}{\theta_{2 0}}} %2B e^{\frac{v_{2}}{\theta_{2 0}}}\right)}"></p>
<div class="highlight"><pre><span></span><span class="c1">#### Deriving the own-elasticity formular</span>
<span class="n">s_diff</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">v_0</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">s_simp</span> <span class="o">=</span> <span class="n">s_diff</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sum_exp_0_0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sum_exp_0_0</span><span class="p">),</span> <span class="n">s_0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth_of_tree</span><span class="p">):</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;s_simp = s_simp.subs(sum_exp_</span><span class="si">%d</span><span class="s1">_0 / sum_</span><span class="si">%d</span><span class="s1">_0, s_</span><span class="si">%d</span><span class="s1"> / s_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
<span class="n">s_simp</span>
</pre></div>


<p><img src="https://render.githubusercontent.com/render/math?math=- s_{3}^{2} %2B \frac{s_{3}}{\theta_{2 0}} - \frac{s_{3}^{2}}{s_{2} \theta_{2 0}} %2B \frac{s_{3}^{2}}{s_{2} \theta_{1 0}} - \frac{s_{3}^{2}}{s_{1} \theta_{1 0}} %2B \frac{s_{3}^{2}}{s_{1} \theta_{0 0}} %2B \frac{s_{3}^{2}}{s_{0}} - \frac{s_{3}^{2}}{s_{0} \theta_{0 0}}"></p>
<div class="highlight"><pre><span></span><span class="n">beta</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">)</span>
<span class="n">p_0</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;p_0&#39;</span><span class="p">)</span>
<span class="n">exec</span><span class="p">(</span><span class="s1">&#39;output = p_0 * beta * expand(s_simp / s_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">depth_of_tree</span><span class="p">)</span>
<span class="n">output</span>
</pre></div>


<p><img src="https://render.githubusercontent.com/render/math?math=\beta p_{0} \left(- s_{3} %2B \frac{1}{\theta_{2 0}} - \frac{s_{3}}{s_{2} \theta_{2 0}} %2B \frac{s_{3}}{s_{2} \theta_{1 0}} - \frac{s_{3}}{s_{1} \theta_{1 0}} %2B \frac{s_{3}}{s_{1} \theta_{0 0}} %2B \frac{s_{3}}{s_{0}} - \frac{s_{3}}{s_{0} \theta_{0 0}}\right)"></p>
<h3>Cross-elasticity</h3>
<div class="highlight"><pre><span></span><span class="c1">#### Deriving the cross-elasticity formular for vehicles in the same make_region (second to the lowest level)</span>
<span class="n">level_of_similarity</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># starts from 0</span>
<span class="n">diff_node</span> <span class="o">=</span> <span class="n">total_end_nodes</span> <span class="o">//</span> <span class="n">number_splits_non_end_node</span> <span class="o">**</span> <span class="n">level_of_similarity</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">exec</span><span class="p">(</span><span class="s1">&#39;s_diff_v_x = diff(s, v_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">diff_node</span><span class="p">)</span>
<span class="n">s_v_0</span> <span class="o">=</span> <span class="n">s</span>
<span class="n">s_simp</span> <span class="o">=</span> <span class="n">s_diff_v_x</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sum_exp_0_0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sum_exp_0_0</span><span class="p">),</span> <span class="n">s_0</span><span class="p">)</span>
<span class="n">s_v_0</span> <span class="o">=</span> <span class="n">s_v_0</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sum_exp_0_0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sum_exp_0_0</span><span class="p">),</span> <span class="n">s_0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">level_of_similarity</span><span class="p">):</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;s_simp = s_simp.subs(sum_exp_</span><span class="si">%d</span><span class="s1">_0 / sum_</span><span class="si">%d</span><span class="s1">_0, s_</span><span class="si">%d</span><span class="s1"> / s_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;s_v_0 = s_v_0.subs(sum_exp_</span><span class="si">%d</span><span class="s1">_0 / sum_</span><span class="si">%d</span><span class="s1">_0, s_</span><span class="si">%d</span><span class="s1"> / s_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">level_of_similarity</span><span class="p">,</span> <span class="n">depth_of_tree</span><span class="p">):</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;s_simp = s_simp.subs(sum_exp_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> / sum_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">, s_</span><span class="si">%d</span><span class="s1"> / s_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">diff_node</span> <span class="o">//</span> <span class="n">number_end_group</span> <span class="o">//</span> <span class="n">number_splits_non_end_node</span> <span class="o">**</span> <span class="p">(</span><span class="n">depth_of_tree</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span>
                                                                           <span class="n">i</span><span class="p">,</span> <span class="n">diff_node</span> <span class="o">//</span> <span class="n">number_end_group</span> <span class="o">//</span> <span class="n">number_splits_non_end_node</span> <span class="o">**</span> <span class="p">(</span><span class="n">depth_of_tree</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;s_v_0 = s_v_0.subs(sum_exp_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1"> / sum_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">, s_</span><span class="si">%d</span><span class="s1"> / s_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">diff_node</span> <span class="o">//</span> <span class="n">number_end_group</span> <span class="o">//</span> <span class="n">number_splits_non_end_node</span> <span class="o">**</span> <span class="p">(</span><span class="n">depth_of_tree</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span>
                                                                           <span class="n">i</span><span class="p">,</span> <span class="n">diff_node</span> <span class="o">//</span> <span class="n">number_end_group</span> <span class="o">//</span> <span class="n">number_splits_non_end_node</span> <span class="o">**</span> <span class="p">(</span><span class="n">depth_of_tree</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
<span class="n">exec</span><span class="p">(</span><span class="s1">&#39;s_simp = s_simp.subs(exp(v_</span><span class="si">%d</span><span class="s1">/theta_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">) / sum_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">, s_</span><span class="si">%d</span><span class="s1"> / s_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">diff_node</span><span class="p">,</span> <span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">diff_node</span> <span class="o">//</span> <span class="n">number_end_group</span><span class="p">,</span>
                                                                           <span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">diff_node</span> <span class="o">//</span> <span class="n">number_end_group</span><span class="p">,</span> <span class="n">depth_of_tree</span><span class="p">,</span>
                                                                              <span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">exec</span><span class="p">(</span><span class="s1">&#39;s_v_0 = s_v_0.subs(exp(v_</span><span class="si">%d</span><span class="s1">/theta_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">) / sum_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">, s_</span><span class="si">%d</span><span class="s1"> / s_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">diff_node</span><span class="p">,</span> <span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">diff_node</span> <span class="o">//</span> <span class="n">number_end_group</span><span class="p">,</span>
                                                                           <span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">diff_node</span> <span class="o">//</span> <span class="n">number_end_group</span><span class="p">,</span> <span class="n">depth_of_tree</span><span class="p">,</span>
                                                                              <span class="n">depth_of_tree</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">)</span>
<span class="n">p_1</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;p_1&#39;</span><span class="p">)</span>
<span class="n">beta</span> <span class="o">*</span> <span class="n">p_1</span> <span class="o">*</span> <span class="n">simplify</span><span class="p">(</span><span class="n">s_simp</span> <span class="o">/</span> <span class="n">s_v_0</span><span class="p">)</span>
</pre></div>


<p><img src="https://render.githubusercontent.com/render/math?math=\beta p_{1} \left(- s_{3} %2B \frac{s_{3}}{s_{0}} - \frac{s_{3}}{s_{0} \theta_{0 0}}\right)"></p>
<div class="highlight"><pre><span></span><span class="c1"># Cross-elasticity with outside option</span>
<span class="n">outside_s</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sum_exp_0_0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sum_exp_0_0</span><span class="p">)</span>
<span class="n">s_diff_v_0</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">outside_s</span><span class="p">,</span> <span class="n">v_0</span><span class="p">)</span>
<span class="n">s_simp</span> <span class="o">=</span> <span class="n">s_diff_v_0</span> <span class="o">/</span> <span class="n">outside_s</span>
<span class="n">s_simp</span> <span class="o">=</span> <span class="n">s_simp</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sum_exp_0_0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sum_exp_0_0</span><span class="p">),</span> <span class="n">s_0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth_of_tree</span><span class="p">):</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;s_simp = s_simp.subs(sum_exp_</span><span class="si">%d</span><span class="s1">_0 / sum_</span><span class="si">%d</span><span class="s1">_0, s_</span><span class="si">%d</span><span class="s1"> / s_</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">)</span>
<span class="n">p_1</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;p_1&#39;</span><span class="p">)</span>
<span class="n">beta</span> <span class="o">*</span> <span class="n">p_1</span> <span class="o">*</span> <span class="n">simplify</span><span class="p">(</span><span class="n">s_simp</span><span class="p">)</span>
</pre></div>


<p><img src="https://render.githubusercontent.com/render/math?math=- \beta p_{1} s_{3}"></p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://github.com/jianghaochu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
    <li class="list-group-item"><a href="https://twitter.com/JianghaoC"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="mailto:jianghaochu@gmail.com" target="_blank">Email</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Jianghao
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>




</body>
</html>